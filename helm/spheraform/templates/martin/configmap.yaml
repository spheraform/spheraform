{{- if .Values.martin.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "spheraform.fullname" . }}-martin-config
  labels:
    {{- include "spheraform.labels" . | nindent 4 }}
    app.kubernetes.io/component: martin
data:
  martin-config.yaml: |
    # Connection pool settings
    pool_size: {{ .Values.martin.config.poolSize }}

    # Auto-discovery settings
    auto_bounds: {{ .Values.martin.config.autoBounds }}
    {{- if .Values.martin.config.autoPublish.enabled }}
    auto_publish:
      tables:
        from_schemas: {{ .Values.martin.config.autoPublish.tables.fromSchemas }}
        id_columns:
        {{- range .Values.martin.config.autoPublish.tables.idColumns }}
          - {{ . }}
        {{- end }}
        source_id_format: {{ .Values.martin.config.autoPublish.tables.sourceIdFormat | quote }}
        tables: {{ .Values.martin.config.autoPublish.tables.tables | quote }}
        buffer: {{ .Values.martin.config.autoPublish.tables.buffer }}
        extent: {{ .Values.martin.config.autoPublish.tables.extent }}
        clip_geom: {{ .Values.martin.config.autoPublish.tables.clipGeom }}
        geometry_column: {{ .Values.martin.config.autoPublish.tables.geometryColumn }}
        srid: {{ .Values.martin.config.autoPublish.tables.srid }}
    {{- end }}

    # Default tile generation settings
    default_srid: {{ .Values.martin.config.defaultSrid }}

    {{- if .Values.martin.pmtiles }}
    # PMTiles sources from object storage
    # Supports: s3://, gs://, az://, file://, https://
    # NOTE: Martin does not support glob patterns for S3.
    # PMTiles sources must be registered individually via API or by listing explicit paths.
    # For dynamic discovery, sources will be added programmatically when datasets are cached.
    pmtiles:
      paths: []  # Empty - sources will be added dynamically or via API
      {{- if and .Values.minio.enabled (eq .Values.martin.pmtiles.storageProtocol "s3://") }}
      # MinIO/S3 credentials (required for Martin v1.0+)
      access_key_id: {{ .Values.minio.rootUser | quote }}
      secret_access_key: {{ .Values.minio.rootPassword | quote }}
      endpoint_url: "http://{{ include "spheraform.fullname" . }}-minio:9000"
      region: "us-east-1"
      allow_http: true
      virtual_hosted_style_request: false  # Path-style for MinIO
      {{- end }}
    {{- end }}
{{- end }}
